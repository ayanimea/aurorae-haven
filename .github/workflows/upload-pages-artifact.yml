name: CI/CD - Build, Test, Security & Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - 'feature-*'
      - 'hotfix-*'
      - 'copilot/**'
  pull_request:
    branches:
      - main
      - 'feature-*'
      - 'hotfix-*'
      - 'copilot/**'
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: 'pages-${{ github.ref }}'
  cancel-in-progress: true

jobs:
  # Job 1: Meta checks (required files exist)
  meta-checks:
    name: Meta required files exist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure copilot instructions present
        run: |
          test -f ".github/copilot-instructions.md" || (echo "Missing .github/copilot-instructions.md" && exit 1)
      - name: Ensure README guidelines present
        run: |
          test -f "README.md" || (echo "Missing README.md" && exit 1)
      - name: Ensure CONTRIBUTING present
        run: |
          test -f "CONTRIBUTING.md" || (echo "Missing CONTRIBUTING.md" && exit 1)

  # Job 2: Markdown link validation
  markdown-links:
    name: Docs validate links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache markdown-link-check
        uses: actions/cache@v4
        id: markdown-link-check-cache
        with:
          path: ~/.npm
          key: ${{ runner.os }}-markdown-link-check-3.14.2-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-markdown-link-check-

      - name: Install markdown-link-check
        run: npm install -g markdown-link-check@3.14.2
        env:
          npm_config_prefer_offline: false

      - name: Check Markdown links
        run: |
          git ls-files -z '*.md' | xargs -0 -n 1 markdown-link-check -c .markdown-link-check.json -q

  # Job 3: Secrets scanning
  gitleaks:
    name: Secrets scan (CLI)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache gitleaks binary
        uses: actions/cache@v4
        id: gitleaks-cache
        with:
          path: ~/.local/bin/gitleaks
          key: ${{ runner.os }}-gitleaks-8.18.4

      - name: Install gitleaks
        if: steps.gitleaks-cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          GITLEAKS_VERSION="8.18.4"
          mkdir -p ~/.local/bin
          curl -sSL -o gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
          tar -xzf gitleaks.tar.gz gitleaks
          mv gitleaks ~/.local/bin/gitleaks
          chmod +x ~/.local/bin/gitleaks
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run gitleaks
        run: |
          gitleaks detect --source . --no-banner --redact

  # Job 4: Test the code
  test:
    needs: [meta-checks, markdown-links, gitleaks]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          # Ensure all dependencies are fetched during setup
          npm_config_prefer_offline: false
          npm_config_audit: false

      - name: Run linter
        run: |
          echo "Running linter on source files..."
          npm run lint
          echo "‚úì All code passes linting checks with zero warnings"

      - name: Remove Jest cache directories
        run: |
          echo "üßπ Removing Jest cache for fresh CI run..."
          # Remove common Jest cache locations
          rm -rf /tmp/jest_* || true
          rm -rf .jest-cache || true
          rm -rf node_modules/.cache/jest || true
          # Clear Jest's cache via CLI
          npm test -- --clearCache || true
          echo "‚úì Jest cache cleared"

      - name: Run tests
        run: npm test -- --coverage --watchAll=false
        env:
          CI: true

      - name: Check for security vulnerabilities
        run: |
          echo "Checking for vulnerabilities..."
          # Run npm audit and capture output
          npm audit --audit-level=moderate > audit-report.txt 2>&1 || true

          # Display the audit report
          cat audit-report.txt

          # Check if there are actual vulnerabilities (not "found 0 vulnerabilities")
          # NONZERO_VULN_PATTERN matches lines like "found 3 vulnerabilities" (i.e., at least one vulnerability found)
          NONZERO_VULN_PATTERN="found [1-9][0-9]* vulnerabilities"
          if grep -qE "$NONZERO_VULN_PATTERN" audit-report.txt; then
            echo "‚ö†Ô∏è Security vulnerabilities detected!"

            # Check for known acceptable vulnerabilities (webpack-dev-server is dev-only)
            if grep -q "webpack-dev-server" audit-report.txt; then
              echo "‚úì webpack-dev-server vulnerabilities are acceptable (dev dependency only, not in production build)"
            fi

            # Check for any HIGH or CRITICAL vulnerabilities
            if grep -qE "(high|critical) severity" audit-report.txt; then
              echo "‚ùå HIGH or CRITICAL vulnerabilities found - deployment blocked!"
              exit 1
            fi

            echo "‚úì Only moderate/low vulnerabilities in dev dependencies - proceeding with deployment"
          else
            echo "‚úì No vulnerabilities found"
          fi

  # Job 5: Build the application
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          # Ensure all dependencies are fetched during setup
          npm_config_prefer_offline: false
          npm_config_audit: false

      - name: Build React PWA with Vite
        run: npm run build
        env:
          CI: true
          VITE_BASE_URL: '/aurorae-haven/'
          # Branch-conditional dev mode: copilot/ and hotfix branches build with dev features
          # IMPORTANT: This enables dev-only controls (fake data button) in the build artifacts.
          # Dev builds from these branches are intended for testing on GitHub Pages only.
          # These branches should NEVER be deployed to production URLs.
          # Security note: Dev features are baked into the build, not runtime-detected.
          # Deployment safety: Ensure branch-protection rules prevent accidental prod deploys.
          NODE_ENV: ${{ (startsWith(github.ref, 'refs/heads/copilot/') || startsWith(github.ref, 'refs/heads/hotfix-')) && 'development' || 'production' }}

      - name: Verify build output
        run: |
          echo "Checking Vite build output..."
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed - dist directory not found!"
            exit 1
          fi

          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Build failed - index.html not found!"
            exit 1
          fi

          echo "‚úì Build successful - dist directory contains:"
          ls -la dist/

          echo "‚úì Verifying critical files exist:"
          test -f dist/index.html && echo "  ‚úì index.html"
          test -f dist/manifest.webmanifest && echo "  ‚úì manifest.webmanifest"
          test -f dist/sw.js && echo "  ‚úì sw.js (service worker)"
          test -d dist/assets && echo "  ‚úì assets/ directory"

      - name: Create offline package
        run: |
          echo "üì¶ Creating offline package for download..."
          echo "This will build the app with relative paths for offline use"
          npm run build:offline
        env:
          CI: true

      - name: Upload offline package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: AuroraeHaven
          path: dist-offline-build/
          retention-days: 90
          if-no-files-found: warn

      - name: Upload offline package to repository branch
        # Only upload on push events, not on pull requests
        if: github.event_name == 'push'
        run: |
          echo "üì¶ Uploading offline package to offline-releases branch..."

          # Get the package file
          PACKAGE_FILE=$(find dist-offline -name "*.tar.gz" -type f | head -1)
          PACKAGE_NAME=$(basename "$PACKAGE_FILE")

          if [ -z "$PACKAGE_FILE" ]; then
            echo "‚ùå No offline package found!"
            exit 1
          fi

          # Get package size in KB
          PACKAGE_SIZE_BYTES=$(stat -f%z "$PACKAGE_FILE" 2>/dev/null || stat -c%s "$PACKAGE_FILE")
          PACKAGE_SIZE_KB=$((PACKAGE_SIZE_BYTES / 1024))

          echo "  ‚Üí Package: $PACKAGE_NAME"
          echo "  ‚Üí Size: ${PACKAGE_SIZE_KB} KB"

          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Create or checkout offline-releases branch
          git fetch origin offline-releases:offline-releases 2>/dev/null || git checkout --orphan offline-releases
          if ! git checkout offline-releases 2>/dev/null; then
            echo "‚ö†Ô∏è Warning: Failed to checkout offline-releases branch. Continuing..."
          fi

          # Clean the branch (keep only offline packages)
          # Remove all tracked files except .git (if any)
          if ! git rm -rf .; then
            echo "‚ùå Failed to remove files from branch!"
            exit 1
          fi

          # Create README for GitHub display
          cat > README.md <<'EOF'
          # üåå Aurorae Haven - Offline Packages

          Welcome to the offline packages branch! This branch contains the latest offline build of Aurorae Haven.

          ## üì¶ Download

          Click on the `.tar.gz` file above to download the latest offline package.

          **Latest Package**: `PACKAGE_NAME_PLACEHOLDER`

          ## üöÄ Quick Start

          1. **Download** the `.tar.gz` file above
          2. **Extract** it (Windows 10+: Right-click ‚Üí Extract All)
          3. **Open** `index.html` in your browser

          ‚ú® **No installation! No server! No internet required!**

          The app works directly from your file system - just download, extract, and double-click!

          ## ‚ú® What's Included

          - ‚úÖ Full React PWA application
          - ‚úÖ Service worker for offline functionality
          - ‚úÖ PWA manifest for installation
          - ‚úÖ All assets optimized and minified
          - ‚úÖ Total size: PACKAGE_SIZE_PLACEHOLDER KB compressed

          ## üìö Full Documentation

          For detailed installation instructions, troubleshooting, and more:

          üëâ [**Offline Download Guide**](https://github.com/aurorae-haven/aurorae-haven/blob/main/docs/OFFLINE-DOWNLOAD.md)

          ## üè† Main Repository

          Back to the main repository:

          üëâ [**Aurorae Haven**](https://github.com/aurorae-haven/aurorae-haven)

          ## üîÑ Updates

          This branch is automatically updated on every build. Check the commit timestamp to see when the package was last updated.

          **Last Updated**: BUILD_DATE_PLACEHOLDER
          **Source Branch**: BUILD_BRANCH_PLACEHOLDER
          **Source Commit**: BUILD_COMMIT_PLACEHOLDER

          ---

          **Built with** ‚ù§Ô∏è **by the Aurorae Haven team**
          EOF

          # Replace placeholders
          sed -i "s/PACKAGE_NAME_PLACEHOLDER/$PACKAGE_NAME/" README.md
          sed -i "s/PACKAGE_SIZE_PLACEHOLDER/$PACKAGE_SIZE_KB/" README.md
          sed -i "s/BUILD_DATE_PLACEHOLDER/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/" README.md
          sed -i "s/BUILD_BRANCH_PLACEHOLDER/${GITHUB_REF##*/}/" README.md
          sed -i "s/BUILD_COMMIT_PLACEHOLDER/${GITHUB_SHA:0:7}/" README.md

          # Create a simple index.html for direct browsing
          cat > index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Aurorae Haven - Offline Packages</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
              h1 { color: #5B21B6; }
              .package { background: #F3F4F6; padding: 1rem; margin: 1rem 0; border-radius: 8px; }
              .package a { color: #5B21B6; text-decoration: none; font-weight: 600; }
              .package a:hover { text-decoration: underline; }
              .info { color: #6B7280; font-size: 0.9rem; }
            </style>
          </head>
          <body>
            <h1>üåå Aurorae Haven - Offline Packages</h1>
            <p>Download the latest offline package to run Aurorae Haven without internet access.</p>

            <div class="package">
              <a href="PACKAGE_NAME_PLACEHOLDER" download>üì¶ PACKAGE_NAME_PLACEHOLDER</a>
              <p class="info">Built: BUILD_DATE_PLACEHOLDER</p>
              <p class="info">Branch: BUILD_BRANCH_PLACEHOLDER | Commit: BUILD_COMMIT_PLACEHOLDER</p>
            </div>

            <h2>Installation Instructions</h2>
            <ol>
              <li>Download the package above</li>
              <li>Extract: <code>tar -xzf PACKAGE_NAME_PLACEHOLDER</code></li>
              <li>Open <code>index.html</code> in your browser</li>
            </ol>

            <p>üìö <a href="https://github.com/aurorae-haven/aurorae-haven/blob/main/docs/OFFLINE-DOWNLOAD.md">Full Documentation</a></p>
            <p>üè† <a href="https://github.com/aurorae-haven/aurorae-haven">Repository</a></p>
          </body>
          </html>
          EOF

          # Replace placeholders in index.html
          sed -i "s/PACKAGE_NAME_PLACEHOLDER/$PACKAGE_NAME/g" index.html
          sed -i "s/BUILD_DATE_PLACEHOLDER/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/" index.html
          sed -i "s/BUILD_BRANCH_PLACEHOLDER/${GITHUB_REF##*/}/" index.html
          sed -i "s/BUILD_COMMIT_PLACEHOLDER/${GITHUB_SHA:0:7}/" index.html

          # Copy the package
          cp "$PACKAGE_FILE" .

          # Add and commit
          git add README.md index.html "$PACKAGE_NAME"
          if git commit -m "Update offline package: $PACKAGE_NAME"; then
            # Push to the branch
            git push -f origin offline-releases
            echo "‚úì Offline package uploaded to offline-releases branch"
            echo "  ‚Üí Access at: https://github.com/${GITHUB_REPOSITORY}/tree/offline-releases"
          else
            echo "No changes to commit. Skipping push to offline-releases branch."
          fi
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  # Job 6: Deploy to GitHub Pages
  deploy:
    needs: build
    runs-on: ubuntu-latest
    # Only deploy on push events, not on pull requests
    if: github.event_name == 'push'
    environment:
      name: github-pages # must be exactly this name for Pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4

      - name: Verify deployment
        run: |
          echo "‚úì Deployment successful!"
          echo "Site URL: ${{ steps.deployment.outputs.page_url }}"
